<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Yılbaşı Kartım</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

      const firebaseConfig = {
        apiKey: "AIzaSyA09HN_U36nliMMA64NjiUDcTmHaVuva7Q",
        authDomain: "yilbasi-karti.firebaseapp.com",
        projectId: "yilbasi-karti",
        storageBucket: "yilbasi-karti.firebasestorage.app",
        messagingSenderId: "897913275226",
        appId: "1:897913275226:web:75a470586445755e112963"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      window.firestoreDB = db;
      window.firestoreCollection = collection;
      window.firestoreAddDoc = addDoc;
      window.firestoreOnSnapshot = onSnapshot;
      window.firestoreQuery = query;
      window.firestoreOrderBy = orderBy;

      // Migration için ek fonksiyonlar
      import { getDocs, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      window.firestoreGetDocs = getDocs;
      window.firestoreDoc = doc;
      window.firestoreUpdateDoc = updateDoc;
    </script>

    <style>
      /* Sayfa arka planı */
      body {
        margin: 0;
        font-family: 'Poppins', sans-serif;
        background: white;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: auto;
        padding: 20px 0;
      }

      /* Çocuk kitabı tarzı bulutlar */
      body::before {
        content: "";
        position: absolute;
        width: 200px;
        height: 80px;
        background: white;
        border-radius: 100px;
        top: 10%;
        left: 5%;
        opacity: 0.7;
        box-shadow: 150px 50px 0 -10px white, 300px 120px 0 -20px white;
      }

      /* Kart alanı */
      .card {
        background: white;
        border-radius: 30px;
        padding: 30px 35px 35px;
        max-width: 520px;
        width: 100%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border: none;
        text-align: center;
        position: relative;
        overflow: visible;
      }

      .card::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image:
          radial-gradient(circle at 20% 30%, #FFE5E5 0, transparent 40%),
          radial-gradient(circle at 80% 70%, #E5F3FF 0, transparent 45%),
          radial-gradient(circle at 50% 90%, #FFF4E5 0, transparent 50%);
        opacity: 0.6;
        z-index: -1;
        border-radius: 25px;
      }

      .title {
        font-size: 2rem;
        font-weight: 900;
        color: #2C3E50;
        margin-bottom: 8px;
        letter-spacing: 0.05em;
      }

      .subtitle {
        font-size: 1.05rem;
        color: #2C3E50;
        margin-bottom: 20px;
        font-weight: 600;
      }

      /* Ağaç alanı */
      .tree-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 30px;
        margin-bottom: 8px;
      }

      .tree-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6b7280;
      }

      .tree {
        position: relative;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .tree-container {
        position: relative;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .tree-image {
        max-width: 100%;
        height: auto;
        filter: drop-shadow(0 8px 20px rgba(0, 0, 0, 0.2));
      }

      /* Ağaca eklenecek süsler - Görsel tabanlı */
      .tree-ornament {
        position: absolute;
        width: 50px;
        height: 50px;
        cursor: pointer;
        animation: ornamentBounce 3s ease-in-out infinite;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      }

      .tree-ornament img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      @keyframes ornamentBounce {
        0%, 100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-5px);
        }
      }

      .hint {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 4px;
      }

      /* Hediye kutusu - Çocuk kitabı stili */
      #gift-box {
        width: 140px;
        height: 130px;
        margin: 20px auto 8px;
        border-radius: 25px;
        background: linear-gradient(135deg, #FF6B9D, #FF4757);
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.2s;
        box-shadow: 0 10px 0 0 #C23B5A, 0 15px 30px rgba(194, 59, 90, 0.4);
        border: 5px solid #C23B5A;
      }

      #gift-box:hover {
        transform: translateY(-8px) scale(1.05) rotate(-2deg);
        box-shadow: 0 15px 0 0 #C23B5A, 0 20px 40px rgba(194, 59, 90, 0.5);
      }

      #gift-box.opened {
        opacity: 0;
        pointer-events: none;
      }

      .gift-ribbon-vertical {
        position: absolute;
        width: 25px;
        height: 100%;
        background: linear-gradient(to right, #FFE66D, #FFF59D, #FFE66D);
        left: 50%;
        transform: translateX(-50%);
        border-left: 3px solid #FFB300;
        border-right: 3px solid #FFB300;
      }

      .gift-ribbon-horizontal {
        position: absolute;
        height: 22px;
        width: 100%;
        background: linear-gradient(to bottom, #FFE66D, #FFF59D, #FFE66D);
        top: 50%;
        transform: translateY(-50%);
        border-top: 3px solid #FFB300;
        border-bottom: 3px solid #FFB300;
      }

      .gift-bow {
        position: absolute;
        top: -20px;
        width: 65px;
        height: 30px;
        background: linear-gradient(135deg, #FFD700, #FFA500);
        border-radius: 999px;
        box-shadow: 0 6px 15px rgba(255, 140, 0, 0.5);
        border: 3px solid #FF8C00;
      }

      .gift-bow::before,
      .gift-bow::after {
        content: "";
        position: absolute;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 4px solid #FF6B00;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(135deg, #FFD700, #FFA500);
        box-shadow: 0 3px 8px rgba(255, 140, 0, 0.4);
      }

      .gift-bow::before {
        left: -18px;
      }
      .gift-bow::after {
        right: -18px;
      }

      .gift-top {
        position: absolute;
        width: 100%;
        height: 18px;
        background: linear-gradient(135deg, #fb7185, #f97316);
        border-radius: 14px 14px 6px 6px;
        top: -10px;
        left: 0;
      }

      .gift-label {
        position: relative;
        z-index: 1;
        font-size: 0.8rem;
        font-weight: 600;
        color: #ffffff;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      /* Noel Baba + form alanı */
      #santa-section {
        margin-top: 18px;
        opacity: 0;
        transform: translateY(18px);
        pointer-events: none;
        transition: opacity 0.6s ease, transform 0.6s ease;
      }

      #santa-section.visible {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .santa-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        margin-bottom: 14px;
      }

      /* Çocuk kitabı stili Santa avatar */
      .santa-avatar {
        width: 90px;
        height: 90px;
        border-radius: 999px;
        background: linear-gradient(135deg, #FF6B6B, #FF4757);
        position: relative;
        box-shadow: 0 10px 0 0 #C23B5A, 0 15px 25px rgba(194, 59, 90, 0.4);
        border: 5px solid #C23B5A;
        animation: float 1.8s ease-in-out infinite;
      }

      .santa-face {
        position: absolute;
        width: 55px;
        height: 48px;
        border-radius: 50px;
        background: linear-gradient(135deg, #FFDAB9, #FFB6A3);
        left: 50%;
        top: 42px;
        transform: translateX(-50%);
        box-shadow: 0 0 0 5px #fff;
        border: 3px solid #FF8C8C;
      }

      .santa-beard {
        position: absolute;
        width: 65px;
        height: 38px;
        background: linear-gradient(135deg, #FFFFFF, #F0F0F0);
        border-radius: 40px;
        left: 50%;
        top: 58px;
        transform: translateX(-50%);
        box-shadow: 0 6px 15px rgba(100, 100, 100, 0.3);
        border: 3px solid #E0E0E0;
      }

      .santa-hat {
        position: absolute;
        width: 68px;
        height: 42px;
        background: linear-gradient(135deg, #FF4757, #C23B5A);
        border-radius: 50px 50px 0 0;
        left: 50%;
        top: 8px;
        transform: translateX(-50%) rotate(-5deg);
        border: 3px solid #C23B5A;
      }

      .santa-hat::before {
        content: "";
        position: absolute;
        width: 75px;
        height: 16px;
        background: linear-gradient(135deg, #FFFFFF, #F0F0F0);
        border-radius: 999px;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        border: 2px solid #E0E0E0;
      }

      .santa-hat::after {
        content: "";
        position: absolute;
        width: 18px;
        height: 18px;
        border-radius: 999px;
        background: linear-gradient(135deg, #FFFFFF, #F0F0F0);
        right: -8px;
        bottom: -8px;
        box-shadow: 0 4px 10px rgba(100, 100, 100, 0.4);
        border: 2px solid #E0E0E0;
      }

      @keyframes float {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-6px);
        }
        100% {
          transform: translateY(0);
        }
      }

      @keyframes shake {
        0%, 100% {
          transform: rotate(0deg);
        }
        10%, 30%, 50%, 70%, 90% {
          transform: rotate(-5deg);
        }
        20%, 40%, 60%, 80% {
          transform: rotate(5deg);
        }
      }

      /* Kar yağma animasyonu */
      .snowflake {
        position: fixed;
        top: -10px;
        color: white;
        font-size: 1.5em;
        user-select: none;
        z-index: 9999;
        pointer-events: none;
        animation: fall linear forwards;
      }

      @keyframes fall {
        to {
          transform: translateY(100vh) rotate(360deg);
          opacity: 0;
        }
      }

      .banner {
        background: linear-gradient(120deg, #FFD93D, #FFA500);
        color: #2C3E50;
        font-weight: 900;
        padding: 10px 20px;
        border-radius: 999px;
        box-shadow: 0 8px 0 0 #FF8C00, 0 12px 20px rgba(255, 140, 0, 0.4);
        border: 4px solid #FF8C00;
        font-size: 1.1rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        text-shadow: 2px 2px 0 rgba(255, 255, 255, 0.5);
      }

      form {
        text-align: left;
      }

      label {
        display: block;
        font-size: 0.85rem;
        color: #374151;
        margin-bottom: 4px;
        font-weight: 600;
      }

      input,
      textarea {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        font-size: 0.9rem;
        font-family: inherit;
        outline: none;
        box-sizing: border-box;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        background: rgba(255, 255, 255, 0.9);
      }

      input:focus,
      textarea:focus {
        border-color: #00a6ff;
        box-shadow: 0 0 0 2px rgba(0, 166, 255, 0.15);
      }

      textarea {
        resize: vertical;
        min-height: 70px;
      }

      .field {
        margin-bottom: 10px;
      }

      /* Süs seçimi */
      .ornament-selector {
        margin-top: 6px;
        margin-bottom: 8px;
      }

      .ornament-selector-label {
        display: block;
        font-size: 0.82rem;
        color: #4b5563;
        margin-bottom: 4px;
        font-weight: 600;
      }

      .ornament-options {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .ornament-option {
        width: 50px;
        height: 50px;
        border: 4px solid transparent;
        cursor: pointer;
        position: relative;
        outline: none;
        padding: 0;
        transition: transform 0.2s ease;
        background: transparent;
        display: inline-block;
      }

      .ornament-option img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
      }

      .ornament-option:hover {
        transform: scale(1.15);
      }

      .ornament-option.selected {
        border-color: transparent;
        animation: shake 2s ease-in-out infinite;
      }

      .ornament-help-text {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-top: 2px;
      }

      .button-row {
        margin-top: 10px;
        text-align: center;
      }

      button[type="submit"] {
        padding: 10px 30px;
        border-radius: 25px;
        border: none;
        font-size: 1rem;
        cursor: pointer;
        background: white;
        color: #2C3E50;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        font-family: inherit;
      }

      button[type="submit"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }

      button[type="submit"]:active {
        transform: translateY(0px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .footnote {
        margin-top: 10px;
        font-size: 0.75rem;
        color: #9ca3af;
        text-align: center;
      }

      /* Popup mesaj */
      .popup-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: white;
        padding: 30px 40px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        text-align: center;
        font-size: 1.2rem;
        font-weight: 600;
        color: #2C3E50;
        opacity: 0;
        transition: all 0.3s ease;
      }

      .popup-message.show {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }

      .popup-message img {
        max-width: 100px;
        height: auto;
        margin-bottom: 15px;
        display: block;
        margin-left: auto;
        margin-right: auto;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="title">Mutlu Yıllar</div>
      <div class="subtitle">
        Dileğini yaz ve ağacı süsleyelim ✨
      </div>

      <!-- Ağaç -->
      <div class="tree-wrapper" id="tree-wrapper">
        <div class="tree-container">
          <div class="tree" id="tree-0" data-tree-index="0">
            <img src="image/bb.png" alt="Yılbaşı Ağacı" class="tree-image">
            <!-- JS ile buraya süsler eklenecek -->
          </div>
        </div>
      </div>


      <!-- AA Görseli Buton -->
      <div id="aa-button-wrapper" style="text-align: center; margin: 20px 0;">
        <img src="image/aa.png" alt="Tıkla" id="aa-button" style="cursor: pointer; max-width: 200px; height: auto; animation: shake 2s ease-in-out infinite;">
      </div>

      <!-- Tıklayınca açılacak form -->
      <div id="santa-section">
        <form id="wish-form">
          <div class="field">
            <label for="name">İsmin</label>
            <input
              type="text"
              id="name"
              name="name"
              placeholder="Adını yaz..."
              required
            />
          </div>

          <div class="field">
            <label for="wish">Yeni yıl dileğin</label>
            <textarea
              id="wish"
              name="wish"
              placeholder="2026 için dileğini buraya yaz..."
              required
            ></textarea>
          </div>

          <!-- Süs seçimi -->
          <div class="ornament-selector">
            <span class="ornament-selector-label">Ağaç süsünü seç</span>
            <div class="ornament-options" id="ornament-options">
              <button
                type="button"
                class="ornament-option"
                data-style="cc"
                aria-label="Süs 1"
              >
                <img src="image/cc.png" alt="Süs 1">
              </button>
              <button
                type="button"
                class="ornament-option"
                data-style="dd"
                aria-label="Süs 2"
              >
                <img src="image/dd.png" alt="Süs 2">
              </button>
              <button
                type="button"
                class="ornament-option"
                data-style="ee"
                aria-label="Süs 3"
              >
                <img src="image/ee.png" alt="Süs 3">
              </button>
              <button
                type="button"
                class="ornament-option"
                data-style="ff"
                aria-label="Süs 4"
              >
                <img src="image/ff.png" alt="Süs 4">
              </button>
            </div>
            <div class="ornament-help-text">
              Send’e bastığında seçtiğin süs ağacın üstüne eklenecek. Süse
              tıklayınca isim ve dileğin görünecek.
            </div>
          </div>

          <div class="button-row">
            <button type="submit">Send</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const aaButton = document.getElementById("aa-button");
      const aaButtonWrapper = document.getElementById("aa-button-wrapper");
      const santaSection = document.getElementById("santa-section");
      const wishForm = document.getElementById("wish-form");
      const tree = document.getElementById("tree");
      const ornamentButtons = document.querySelectorAll(".ornament-option");

      let selectedOrnamentStyle = null;
      let ornamentCount = 0;

      // Her ağaçta max 20 süs olacak
      const MAX_ORNAMENTS_PER_TREE = 20;

      // Ağacın üzerinde kullanılacak pozisyonlar (20 pozisyon)
      // Ağaç şeklinde yukarıdan aşağıya doğru genişleyen bir dağılım - daha fazla boşluklu
      const ornamentPositions = [
        { top: "15%", left: "50%" },   // Seviye 1: En üst (1)

        { top: "27%", left: "42%" },   // Seviye 2: İki yan (2)
        { top: "27%", left: "58%" },

        { top: "39%", left: "35%" },   // Seviye 3: Üç sıra (3)
        { top: "39%", left: "50%" },
        { top: "39%", left: "65%" },

        { top: "51%", left: "30%" },   // Seviye 4: Dört sıra (4)
        { top: "51%", left: "43%" },
        { top: "51%", left: "57%" },
        { top: "51%", left: "70%" },

        { top: "63%", left: "26%" },   // Seviye 5: Beş sıra (5)
        { top: "63%", left: "37%" },
        { top: "63%", left: "50%" },
        { top: "63%", left: "63%" },
        { top: "63%", left: "74%" },

        { top: "75%", left: "23%" },   // Seviye 6: Altı sıra (6)
        { top: "75%", left: "33%" },
        { top: "75%", left: "43%" },
        { top: "75%", left: "57%" },
        { top: "75%", left: "67%" },
        { top: "75%", left: "77%" },
      ];

      // Tüm ağaçları ve her ağaçtaki kullanılmış pozisyonları takip etmek için
      let trees = [];
      const usedPositionsByTree = {};

      // Yeni ağaç ekle
      function addNewTree() {
        const treeWrapper = document.getElementById('tree-wrapper');
        const newTreeIndex = trees.length;

        const treeContainer = document.createElement('div');
        treeContainer.className = 'tree-container';

        const newTree = document.createElement('div');
        newTree.className = 'tree';
        newTree.id = `tree-${newTreeIndex}`;
        newTree.dataset.treeIndex = newTreeIndex;
        newTree.innerHTML = '<img src="image/bb.png" alt="Yılbaşı Ağacı" class="tree-image">';

        treeContainer.appendChild(newTree);
        treeWrapper.appendChild(treeContainer);

        trees.push(newTree);
        usedPositionsByTree[newTreeIndex] = new Set();

        return newTree;
      }

      // Firestore'dan süsleri yükle ve gerçek zamanlı dinle
      function loadOrnaments() {
        if (!window.firestoreDB) {
          console.log('Firebase henüz hazır değil, bekleniyor...');
          setTimeout(loadOrnaments, 100);
          return;
        }

        const q = window.firestoreQuery(
          window.firestoreCollection(window.firestoreDB, 'ornaments'),
          window.firestoreOrderBy('timestamp', 'asc')
        );

        window.firestoreOnSnapshot(q, (snapshot) => {
          // Önce mevcut süsleri temizle
          trees.forEach(tree => {
            const ornaments = tree.querySelectorAll('.tree-ornament');
            ornaments.forEach(orn => orn.remove());
          });

          // Kullanılmış pozisyonları sıfırla
          Object.keys(usedPositionsByTree).forEach(key => {
            usedPositionsByTree[key].clear();
          });

          // Ağaç sayısını hesapla
          let maxTreeIndex = 0;
          snapshot.docs.forEach(doc => {
            const data = doc.data();
            if (data.treeIndex > maxTreeIndex) {
              maxTreeIndex = data.treeIndex;
            }
          });

          // Gerekli ağaçları oluştur
          while (trees.length <= maxTreeIndex) {
            addNewTree();
          }

          // Süsleri ekle
          snapshot.docs.forEach(doc => {
            const ornData = doc.data();
            const treeElement = document.getElementById(`tree-${ornData.treeIndex}`);
            if (!treeElement) return;

            if (!usedPositionsByTree[ornData.treeIndex]) {
              usedPositionsByTree[ornData.treeIndex] = new Set();
            }
            usedPositionsByTree[ornData.treeIndex].add(ornData.positionIndex);

            const ornament = document.createElement("div");
            ornament.className = "tree-ornament";
            ornament.style.top = ornData.top;
            ornament.style.left = ornData.left;
            ornament.dataset.name = ornData.name;
            ornament.dataset.wish = ornData.wish;
            ornament.dataset.positionIndex = ornData.positionIndex;

            const ornamentImg = document.createElement("img");
            ornamentImg.src = `image/${ornData.style}.png`;
            ornamentImg.alt = "Süs";
            ornament.appendChild(ornamentImg);

            ornament.addEventListener("click", () => {
              alert(
                `${ornament.dataset.name} diliyor ki:\n\n"${ornament.dataset.wish}"`
              );
            });

            treeElement.appendChild(ornament);
          });
        });
      }

      // Firestore'a süs kaydet
      async function saveOrnamentToFirestore(ornamentData) {
        try {
          await window.firestoreAddDoc(
            window.firestoreCollection(window.firestoreDB, 'ornaments'),
            ornamentData
          );
        } catch (error) {
          console.error('Süs kaydedilirken hata oluştu:', error);
          alert('Süs kaydedilirken bir hata oluştu. Lütfen tekrar deneyin.');
        }
      }

      // Pozisyon migration - mevcut süsleri yeni pozisyonlara taşı
      async function migrateOrnamentPositions() {
        if (!window.firestoreDB || !window.firestoreGetDocs) {
          console.log('Firebase henüz hazır değil, migration bekleniyor...');
          setTimeout(migrateOrnamentPositions, 100);
          return;
        }

        try {
          const q = window.firestoreQuery(
            window.firestoreCollection(window.firestoreDB, 'ornaments'),
            window.firestoreOrderBy('timestamp', 'asc')
          );

          const snapshot = await window.firestoreGetDocs(q);

          console.log(`${snapshot.docs.length} süs bulundu, pozisyonlar güncelleniyor...`);

          for (let i = 0; i < snapshot.docs.length; i++) {
            const ornDoc = snapshot.docs[i];
            const data = ornDoc.data();

            // Yeni pozisyon indexini hesapla
            const newPos = ornamentPositions[data.positionIndex];

            if (newPos && (data.top !== newPos.top || data.left !== newPos.left)) {
              // Pozisyon güncellenmeli
              await window.firestoreUpdateDoc(
                window.firestoreDoc(window.firestoreDB, 'ornaments', ornDoc.id),
                {
                  top: newPos.top,
                  left: newPos.left
                }
              );
              console.log(`Süs ${i + 1} pozisyonu güncellendi`);
            }
          }

          console.log('Migration tamamlandı!');
        } catch (error) {
          console.error('Migration hatası:', error);
        }
      }

      // Migration'ı bir kez çalıştır (sayfa yüklendiğinde)
      let migrationRun = false;
      if (!migrationRun) {
        migrationRun = true;
        setTimeout(migrateOrnamentPositions, 2000);
      }

      // İlk ağacı trees dizisine ekle
      trees.push(document.getElementById('tree-0'));
      usedPositionsByTree[0] = new Set();

      // Sayfa yüklendiğinde süsleri yükle
      loadOrnaments();

      // AA butonuna tıklayınca formu göster
      aaButton.addEventListener("click", () => {
        aaButtonWrapper.style.display = "none";
        santaSection.classList.add("visible");
      });

      // Süs butonlarına tıklama (seçim)
      ornamentButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          ornamentButtons.forEach((b) => b.classList.remove("selected"));
          btn.classList.add("selected");
          selectedOrnamentStyle = btn.dataset.style;
        });
      });

      // Form submit olunca:
      // 1) İsim + dilek + süs seçimi kontrol
      // 2) Ağacın üstüne süs ekle
      // 3) Süse tıklayınca isim + dilek göster
      wishForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("name").value.trim();
        const wish = document.getElementById("wish").value.trim();

        if (!name || !wish) {
          alert("Lütfen isim ve dilek alanlarını doldur.");
          return;
        }

        if (!selectedOrnamentStyle) {
          alert("Lütfen bir ağaç süsü seç.");
          return;
        }

        // Son ağacı bul veya yeni ağaç ekle
        let targetTree = trees[trees.length - 1];
        let targetTreeIndex = trees.length - 1;

        // Son ağaçta boş pozisyon ara
        let positionIndex = -1;
        for (let i = 0; i < ornamentPositions.length; i++) {
          if (!usedPositionsByTree[targetTreeIndex].has(i)) {
            positionIndex = i;
            break;
          }
        }

        // Eğer son ağaç doluysa yeni ağaç ekle
        if (positionIndex === -1) {
          targetTree = addNewTree();
          targetTreeIndex = trees.length - 1;
          positionIndex = 0; // Yeni ağaçta ilk pozisyon
        }

        const pos = ornamentPositions[positionIndex];

        // Firestore'a kaydet (listener otomatik olarak ağaca ekleyecek)
        const ornamentData = {
          treeIndex: targetTreeIndex,
          positionIndex: positionIndex,
          top: pos.top,
          left: pos.left,
          name: name,
          wish: wish,
          style: selectedOrnamentStyle,
          timestamp: new Date()
        };

        await saveOrnamentToFirestore(ornamentData);

        // Kar yağma animasyonunu başlat
        createSnowfall();

        // Popup mesaj göster
        showPopupMessage('<img src="image/gd.png" alt=""><div>Bu yıl bütün dileklerinizin gerçekleşmesi dileğiyle<br>- Lara Musluoğlu</div>');

        // Formu temizle ama seçilen süs seçili kalsın
        wishForm.reset();
      });

      // Kar yağma fonksiyonu
      function createSnowfall() {
        const snowflakeCount = 150;
        for (let i = 0; i < snowflakeCount; i++) {
          setTimeout(() => {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            snowflake.innerHTML = '❄';
            snowflake.style.left = Math.random() * 100 + 'vw';
            snowflake.style.animationDuration = (Math.random() * 3 + 2) + 's';
            snowflake.style.opacity = Math.random() * 0.7 + 0.3;
            snowflake.style.fontSize = (Math.random() * 1.5 + 0.5) + 'em';
            document.body.appendChild(snowflake);

            // Animasyon bitince elementi kaldır
            setTimeout(() => {
              snowflake.remove();
            }, 5000);
          }, i * 30);
        }
      }

      // Popup mesaj gösterme fonksiyonu
      function showPopupMessage(message) {
        const popup = document.createElement('div');
        popup.className = 'popup-message';
        popup.innerHTML = message;
        document.body.appendChild(popup);

        // Kısa bir gecikme sonra göster
        setTimeout(() => {
          popup.classList.add('show');
        }, 100);

        // 3 saniye sonra kaldır
        setTimeout(() => {
          popup.classList.remove('show');
          setTimeout(() => {
            popup.remove();
          }, 300);
        }, 3000);
      }
    </script>
  </body>
</html>

